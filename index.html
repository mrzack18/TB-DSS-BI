<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pendukung Keputusan & Business Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #1e293b; /* slate-800 */
        }
        .container {
            max-width: 1024px; /* Slightly wider container */
            margin: 0 auto;
            padding: 2rem;
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* stronger shadow */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e2e8f0;
        }
        h1 {
            color: #1d4ed8; /* blue-700 */
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
        }
        h2 {
            color: #334155; /* slate-700 */
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 0.75rem;
        }
        .step-dot {
            width: 10px;
            height: 10px;
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .step-dot.active {
            background-color: #2563eb; /* blue-600 */
        }

        /* Custom styles for input range */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px; /* Slightly thicker */
            background: #d1d5db; /* gray-300 */
            border-radius: 5px;
            outline: none;
            opacity: 0.8; /* Slightly less opaque */
            transition: opacity .2s;
            margin-top: 0.75rem; /* Spacing */
            margin-bottom: 0.5rem;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px; /* Slightly larger thumb */
            height: 24px;
            background: #2563eb; /* blue-600 */
            border-radius: 50%;
            cursor: grab; /* Cursor hint */
            box-shadow: 0 2px 8px rgba(0,0,0,0.25); /* Stronger shadow */
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
            background: #1e40af; /* blue-800 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #2563eb;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb:active {
            cursor: grabbing;
            background: #1e40af;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .hidden {
            display: none;
        }
        .error-message {
            color: #dc2626; /* red-600 */
            font-size: 0.875rem; /* text-sm */
            font-style: italic;
            margin-top: 0.75rem;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: separate; /* Use separate for rounded corners */
            border-spacing: 0; /* Remove space between borders */
            margin-top: 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        th, td {
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 1rem 1.25rem; /* More padding */
            text-align: left;
        }
        th {
            background-color: #f1f5f9; /* slate-100 */
            font-weight: 600;
            color: #334155; /* slate-700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
        }
        tbody tr:nth-child(even) {
            background-color: #f8fafc; /* slate-50 for subtle stripe */
        }
        tbody tr:hover {
            background-color: #eff6ff; /* blue-50 on hover */
        }
        .button-primary {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 700; /* font-bold */
            padding: 0.75rem 1.75rem; /* py-3 px-7 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .button-primary:hover {
            background-color: #1d4ed8; /* blue-700 */
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .button-secondary {
            background-color: #64748b; /* slate-500 */
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .button-secondary:hover {
            background-color: #475569; /* slate-600 */
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .card {
            padding: 1.5rem;
            background-color: #f8fafc; /* slate-50 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* light shadow */
            border: 1px solid #e2e8f0; /* slate-200 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-center items-center py-10">
    <div class="container w-full md:w-4/5 lg:w-3/4">

        <h1 class="text-4xl font-extrabold text-center mb-4">Sistem Pendukung Keputusan & Business Intelligence</h1>
        <h2 class="text-3xl font-bold text-center mb-10 text-slate-700">Perankingan Karyawan dengan Metode AHP</h2>

        <div class="step-indicator" id="step-indicator">
            <div class="step-dot active" data-step="0"></div>
            <div class="step-dot" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
            <div class="step-dot" data-step="5"></div>
        </div>

        <section id="setup-section" class="space-y-8">
            <p class="text-center text-slate-600 text-lg">Mulailah dengan menentukan jumlah kriteria penilaian dan karyawan yang akan Anda ranking.</p>

            <div class="card space-y-6">
                <div>
                    <label for="num_criteria" class="block text-slate-700 text-base font-semibold mb-2">Jumlah Kriteria Penilaian:</label>
                    <input type="number" id="num_criteria" min="1" placeholder="Masukkan jumlah kriteria (misal: 3)" required
                           class="shadow-sm appearance-none border border-slate-300 rounded-md w-full py-2.5 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
                <div>
                    <label for="num_employees" class="block text-slate-700 text-base font-semibold mb-2">Jumlah Karyawan yang Dinilai:</label>
                    <input type="number" id="num_employees" min="1" placeholder="Masukkan jumlah karyawan (misal: 5)" required
                           class="shadow-sm appearance-none border border-slate-300 rounded-md w-full py-2.5 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
            </div>
            <p id="setup-error" class="error-message hidden"></p>
            <div class="flex justify-center mt-8">
                <button type="button" onclick="setupProject()" class="button-primary">
                    Lanjutkan <span class="ml-2">&rarr;</span>
                </button>
            </div>
        </section>

        <section id="define-criteria-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-slate-700 mb-4">Definisikan Kriteria Penilaian Anda</h3>
            <p class="text-center text-slate-600 mb-8">Masukkan nama-nama kriteria yang relevan untuk proses perankingan karyawan.</p>
            <div id="criteria-inputs" class="space-y-5 card">
                </div>
            <p id="define-criteria-error" class="error-message hidden"></p>
            <div class="flex justify-between mt-8">
                <button type="button" onclick="showSection('setup-section', 0)" class="button-secondary">
                    <span class="mr-2">&larr;</span> Kembali
                </button>
                <button type="button" onclick="saveCriteria()" class="button-primary">
                    Lanjutkan ke Perbandingan Kriteria <span class="ml-2">&rarr;</span>
                </button>
            </div>
        </section>

        <section id="compare-criteria-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-slate-700 mb-4">Bandingkan Kriteria</h3>
            <p class="text-center text-slate-600 mb-8">Tentukan tingkat kepentingan setiap kriteria satu sama lain. Gunakan skala Saaty (1-9).</p>
            <p class="text-center text-slate-500 text-sm mb-6 italic">1 = Sama penting, 3 = Agak lebih penting, 5 = Lebih penting, 7 = Sangat lebih penting, 9 = Ekstrem penting.</p>
            <div id="criteria-comparisons" class="space-y-6 card">
                </div>
            <p id="compare-criteria-error" class="error-message hidden"></p>
            <div class="flex justify-between mt-8">
                <button type="button" onclick="defineCriteria()" class="button-secondary">
                    <span class="mr-2">&larr;</span> Kembali
                </button>
                <button type="button" onclick="calculateCriteriaPriorities()" class="button-primary">
                    Lanjutkan ke Definisi Karyawan <span class="ml-2">&rarr;</span>
                </button>
            </div>
        </section>

        <section id="define-employees-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-slate-700 mb-4">Definisikan Karyawan Anda</h3>
            <p class="text-center text-slate-600 mb-8">Masukkan nama-nama karyawan yang akan dievaluasi dan diranking.</p>
            <div id="employee-inputs" class="space-y-5 card">
                </div>
            <p id="define-employees-error" class="error-message hidden"></p>
            <div class="flex justify-between mt-8">
                <button type="button" onclick="showSection('compare-criteria-section', 2)" class="button-secondary">
                    <span class="mr-2">&larr;</span> Kembali
                </button>
                <button type="button" onclick="saveEmployees()" class="button-primary">
                    Lanjutkan ke Perbandingan Karyawan <span class="ml-2">&rarr;</span>
                </button>
            </div>
        </section>

        <section id="compare-employees-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-slate-700 mb-4">Perbandingan Karyawan</h3>
            <p class="text-center text-slate-600 mb-4">Bandingkan setiap karyawan berdasarkan kriteria: <span id="current-criteria-name" class="font-bold text-blue-600 text-xl"></span></p>
            <p class="text-center text-slate-500 text-sm mb-6 italic">Gunakan skala Saaty (1-9) untuk menilai seberapa baik satu karyawan dibandingkan yang lain pada kriteria ini.</p>
            <div id="employee-comparisons" class="space-y-6 card">
                </div>
            <p id="compare-employees-error" class="error-message hidden"></p>
            <div class="flex justify-between mt-8">
                <button type="button" id="prev-criteria-btn" onclick="prevCriteria()" class="button-secondary">
                    <span class="mr-2">&larr;</span> Kriteria Sebelumnya
                </button>
                <button type="button" onclick="calculateEmployeePriorities()" class="button-primary">
                    Lanjutkan <span class="ml-2">&rarr;</span>
                </button>
            </div>
        </section>

        <section id="results-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-slate-700 mb-4">Hasil Perankingan Karyawan</h3>
            <p class="text-center text-slate-600 mb-8">Berikut adalah hasil analisis AHP untuk perankingan karyawan Anda.</p>

            <div class="card mb-8 bg-blue-50 border-blue-200">
                <h4 class="text-xl font-semibold text-blue-800 mb-4">Bobot Prioritas Kriteria</h4>
                <div class="overflow-x-auto">
                    <table id="criteria-weights-table">
                        <thead>
                            <tr>
                                <th>Kriteria</th>
                                <th>Bobot</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-sm text-slate-600">
                    <span class="font-semibold">Konsistensi Kriteria (CR):</span> <span id="criteria-cr-value"></span> <span id="criteria-consistency-message" class="font-medium"></span>
                    <span id="criteria-cr-warning" class="text-red-600 font-bold hidden"> - Perlu perbaikan perbandingan kriteria! CR harus ≤ 0.10.</span>
                </p>
            </div>

            <div class="card mb-8 bg-green-50 border-green-200">
                <h4 class="text-xl font-semibold text-green-800 mb-4">Peringkat Karyawan Akhir</h4>
                <div class="overflow-x-auto">
                    <table id="ranked-employees-table">
                        <thead>
                            <tr>
                                <th>Peringkat</th>
                                <th>Nama Karyawan</th>
                                <th>Skor Akhir</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card mb-8 bg-yellow-50 border-yellow-200">
                <h4 class="text-xl font-semibold text-yellow-800 mb-4">Konsistensi Perbandingan Karyawan per Kriteria</h4>
                <div class="overflow-x-auto">
                    <table id="employee-crs-table">
                        <thead>
                            <tr>
                                <th>Kriteria</th>
                                <th>CR</th>
                                <th>Pesan Konsistensi</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 flex justify-center">
                <button type="button" onclick="initApp()" class="button-secondary">
                    <span class="mr-2">&larr;</span> Mulai Ulang
                </button>
            </div>
        </section>

    </div>

    <script>
        // Global State Variables
        let numCriteria = 0;
        let numEmployees = 0;
        let criteriaNames = [];
        let employeeNames = [];
        let criteriaMatrix = [];
        let employeeMatrices = {}; // Stores matrices for each criterion
        let criteriaPriorityVector = [];
        let employeePriorityVectors = {}; // Stores priority vectors for each criterion
        let criteriaCR = 0;
        let employeeCRs = {}; // Stores CRs for each criterion
        let currentCriteriaIdx = 0;
        let currentStep = 0; // To manage step indicator

        // Random Index (RI) values for Consistency Ratio calculation
        const RI_VALUES = {
            1: 0.00, 2: 0.00, 3: 0.58, 4: 0.90, 5: 1.12, 6: 1.24, 7: 1.32, 8: 1.41,
            9: 1.45, 10: 1.49, 11: 1.51, 12: 1.48, 13: 1.56, 14: 1.57, 15: 1.59
        };

        // Helper function to update step indicator
        function updateStepIndicator(step) {
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((dot, index) => {
                if (index === step) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            currentStep = step;
        }

        // Helper function to show a specific section and hide others
        function showSection(sectionId, step) {
            const sections = ['setup-section', 'define-criteria-section', 'compare-criteria-section',
                              'define-employees-section', 'compare-employees-section', 'results-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            updateStepIndicator(step);
        }

        // AHP Calculation Functions (JavaScript equivalent of Python numpy)
        function createMatrix(rows, cols, value = 0) {
            return Array(rows).fill(0).map(() => Array(cols).fill(value));
        }

        function sumColumns(matrix) {
            return matrix[0].map((_, colIdx) => matrix.reduce((sum, row) => sum + row[colIdx], 0));
        }

        function normalizeMatrix(matrix) {
            const numRows = matrix.length;
            const numCols = matrix[0].length;
            const colSums = sumColumns(matrix);
            const normalizedMatrix = createMatrix(numRows, numCols);

            for (let i = 0; i < numRows; i++) {
                for (let j = 0; j < numCols; j++) {
                    normalizedMatrix[i][j] = matrix[i][j] / colSums[j];
                }
            }
            return normalizedMatrix;
        }

        function calculatePriorityVector(matrix) {
            const normalizedMatrix = normalizeMatrix(matrix);
            const numRows = normalizedMatrix.length;
            const priorityVector = Array(numRows).fill(0);

            for (let i = 0; i < numRows; i++) {
                priorityVector[i] = normalizedMatrix[i].reduce((sum, val) => sum + val, 0) / numRows;
            }
            return priorityVector;
        }

        function dotProduct(matrix, vector) {
            const numRows = matrix.length;
            const numCols = matrix[0].length;
            const resultVector = Array(numRows).fill(0);

            for (let i = 0; i < numRows; i++) {
                for (let j = 0; j < numCols; j++) {
                    resultVector[i] += matrix[i][j] * vector[j];
                }
            }
            return resultVector;
        }

        function calculateConsistencyRatio(matrix, priorityVector) {
            const n = matrix.length;
            if (n <= 2) { // For n=1 or n=2, CR is always 0, and consistency is perfect.
                return { cr: 0.0, message: "Konsisten" };
            }

            // Calculate Lambda Max (λ_max)
            const weightedSumVector = dotProduct(matrix, priorityVector);
            // Handle division by zero if priorityVector has zero elements
            const lambdaMaxVector = weightedSumVector.map((val, i) => priorityVector[i] !== 0 ? val / priorityVector[i] : 0);
            const lambdaMax = lambdaMaxVector.reduce((sum, val) => sum + val, 0) / n;

            // Calculate Consistency Index (CI)
            const CI = (lambdaMax - n) / (n - 1);

            // Get Random Index (RI)
            const RI = RI_VALUES[n] || 1.59; // Default to 1.59 for n > 15

            // Calculate Consistency Ratio (CR)
            const CR = RI !== 0 ? CI / RI : 0.0;

            const consistencyMessage = CR <= 0.10 ? "Konsisten" : "Tidak Konsisten (Perlu perbaikan)";
            return { cr: CR, message: consistencyMessage };
        }

        // Main App Flow Functions
        function initApp() {
            // Clear all previous state
            numCriteria = 0;
            numEmployees = 0;
            criteriaNames = [];
            employeeNames = [];
            criteriaMatrix = [];
            employeeMatrices = {};
            criteriaPriorityVector = [];
            employeePriorityVectors = {};
            criteriaCR = 0;
            employeeCRs = {};
            currentCriteriaIdx = 0;

            // Clear previous inputs
            document.getElementById('num_criteria').value = '';
            document.getElementById('num_employees').value = '';
            document.getElementById('setup-error').classList.add('hidden');
            document.getElementById('define-criteria-error').classList.add('hidden');
            document.getElementById('compare-criteria-error').classList.add('hidden');
            document.getElementById('define-employees-error').classList.add('hidden');
            document.getElementById('compare-employees-error').classList.add('hidden');

            showSection('setup-section', 0);
        }

        function setupProject() {
            const numCritInput = document.getElementById('num_criteria');
            const numEmpInput = document.getElementById('num_employees');
            const errorDisplay = document.getElementById('setup-error');

            numCriteria = parseInt(numCritInput.value);
            numEmployees = parseInt(numEmpInput.value);

            if (isNaN(numCriteria) || numCriteria <= 0 || isNaN(numEmployees) || numEmployees <= 0) {
                errorDisplay.textContent = "Jumlah kriteria dan karyawan harus angka positif.";
                errorDisplay.classList.remove('hidden');
                return;
            }
            errorDisplay.classList.add('hidden');
            criteriaNames = Array(numCriteria).fill('');
            employeeNames = Array(numEmployees).fill('');
            defineCriteria();
        }

        function defineCriteria() {
            const criteriaInputsDiv = document.getElementById('criteria-inputs');
            criteriaInputsDiv.innerHTML = ''; // Clear previous inputs

            for (let i = 0; i < numCriteria; i++) {
                const div = document.createElement('div');
                div.className = 'mb-4';
                div.innerHTML = `
                    <label for="criteria_${i}" class="block text-slate-700 text-sm font-semibold mb-2">Nama Kriteria ${i + 1}:</label>
                    <input type="text" id="criteria_${i}" name="criteria_${i}" value="${criteriaNames[i] || ''}" placeholder="Contoh: Kinerja, Disiplin, Inovasi" required
                            class="shadow-sm appearance-none border border-slate-300 rounded-md w-full py-2.5 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                `;
                criteriaInputsDiv.appendChild(div);
            }
            showSection('define-criteria-section', 1);
        }

        function saveCriteria() {
            const errorDisplay = document.getElementById('define-criteria-error');
            const newCriteriaNames = [];
            let allFilled = true;

            for (let i = 0; i < numCriteria; i++) {
                const input = document.getElementById(`criteria_${i}`);
                if (!input.value.trim()) {
                    allFilled = false;
                    break;
                }
                newCriteriaNames.push(input.value.trim());
            }

            if (!allFilled) {
                errorDisplay.textContent = "Semua nama kriteria harus diisi.";
                errorDisplay.classList.remove('hidden');
                return;
            }
            errorDisplay.classList.add('hidden');
            criteriaNames = newCriteriaNames;
            compareCriteria();
        }

        function compareCriteria() {
            const criteriaComparisonsDiv = document.getElementById('criteria-comparisons');
            criteriaComparisonsDiv.innerHTML = ''; // Clear previous comparisons

            const comparisons = [];
            for (let i = 0; i < numCriteria; i++) {
                for (let j = i + 1; j < numCriteria; j++) {
                    comparisons.push([i, j]);
                }
            }

            if (numCriteria <= 1) { // If only 0 or 1 criteria, skip comparison
                calculateCriteriaPriorities(); // Directly move to next step
                return;
            }

            comparisons.forEach((pair, index) => {
                const [idx1, idx2] = pair;
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200'; /* Changed background for comparison items */
                div.innerHTML = `
                    <label for="criteria_comp_${index}" class="block text-slate-800 text-md font-semibold mb-3">
                        Seberapa pentingkah <span class="font-bold text-blue-700">${criteriaNames[idx1]}</span> dibandingkan <span class="font-bold text-blue-700">${criteriaNames[idx2]}</span>?
                    </label>
                    <input type="range" id="criteria_comp_${index}" name="criteria_comp_${index}" min="1" max="9" step="1" value="1"
                            oninput="this.nextElementSibling.value = this.value">
                    <output class="block text-center text-blue-600 font-bold mt-2">1</output>
                `;
                criteriaComparisonsDiv.appendChild(div);
            });
            showSection('compare-criteria-section', 2);
        }

        function calculateCriteriaPriorities() {
            const errorDisplay = document.getElementById('compare-criteria-error');
            criteriaMatrix = createMatrix(numCriteria, numCriteria);
            for (let i = 0; i < numCriteria; i++) {
                criteriaMatrix[i][i] = 1; // Diagonal elements are 1
            }

            if (numCriteria <= 1) { // If only 0 or 1 criteria, set default priority
                criteriaPriorityVector = Array(numCriteria).fill(1 / numCriteria);
                criteriaCR = 0;
            } else {
                const comparisons = [];
                for (let i = 0; i < numCriteria; i++) {
                    for (let j = i + 1; j < numCriteria; j++) {
                        comparisons.push([i, j]);
                    }
                }

                comparisons.forEach((pair, index) => {
                    const [idx1, idx2] = pair;
                    const value = parseFloat(document.getElementById(`criteria_comp_${index}`).value);
                    criteriaMatrix[idx1][idx2] = value;
                    criteriaMatrix[idx2][idx1] = 1 / value;
                });

                criteriaPriorityVector = calculatePriorityVector(criteriaMatrix);
                const { cr, message } = calculateConsistencyRatio(criteriaMatrix, criteriaPriorityVector);
                criteriaCR = cr;

                if (cr > 0.10) {
                    errorDisplay.textContent = `Perbandingan kriteria tidak konsisten (CR = ${cr.toFixed(4)}). Mohon periksa kembali input Anda.`;
                    errorDisplay.classList.remove('hidden');
                    return;
                }
            }
            errorDisplay.classList.add('hidden');
            defineEmployees();
        }

        function defineEmployees() {
            const employeeInputsDiv = document.getElementById('employee-inputs');
            employeeInputsDiv.innerHTML = ''; // Clear previous inputs

            for (let i = 0; i < numEmployees; i++) {
                const div = document.createElement('div');
                div.className = 'mb-4';
                div.innerHTML = `
                    <label for="employee_${i}" class="block text-slate-700 text-sm font-semibold mb-2">Nama Karyawan ${i + 1}:</label>
                    <input type="text" id="employee_${i}" name="employee_${i}" value="${employeeNames[i] || ''}" placeholder="Contoh: Budi, Siti, Anton" required
                            class="shadow-sm appearance-none border border-slate-300 rounded-md w-full py-2.5 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                `;
                employeeInputsDiv.appendChild(div);
            }
            showSection('define-employees-section', 3);
        }

        function saveEmployees() {
            const errorDisplay = document.getElementById('define-employees-error');
            const newEmployeeNames = [];
            let allFilled = true;

            for (let i = 0; i < numEmployees; i++) {
                const input = document.getElementById(`employee_${i}`);
                if (!input.value.trim()) {
                    allFilled = false;
                    break;
                }
                newEmployeeNames.push(input.value.trim());
            }

            if (!allFilled) {
                errorDisplay.textContent = "Semua nama karyawan harus diisi.";
                errorDisplay.classList.remove('hidden');
                return;
            }
            errorDisplay.classList.add('hidden');
            employeeNames = newEmployeeNames;
            currentCriteriaIdx = 0; // Start comparisons for the first criterion
            compareEmployees();
        }

        function compareEmployees() {
            const currentCriteriaNameSpan = document.getElementById('current-criteria-name');
            const employeeComparisonsDiv = document.getElementById('employee-comparisons');
            const errorDisplay = document.getElementById('compare-employees-error');
            errorDisplay.classList.add('hidden'); // Hide previous errors

            const prevCriteriaBtn = document.getElementById('prev-criteria-btn');
            // If it's the very first criteria, and we're starting comparisons, the back button should go to define employees
            if (currentCriteriaIdx === 0) {
                prevCriteriaBtn.onclick = () => showSection('define-employees-section', 3);
                prevCriteriaBtn.textContent = '← Kembali ke Definisi Karyawan';
            } else {
                prevCriteriaBtn.onclick = prevCriteria;
                prevCriteriaBtn.textContent = '← Kriteria Sebelumnya';
            }


            if (currentCriteriaIdx >= numCriteria) {
                showResults();
                return;
            }

            const currentCriteria = criteriaNames[currentCriteriaIdx];
            currentCriteriaNameSpan.textContent = currentCriteria;
            employeeComparisonsDiv.innerHTML = ''; // Clear previous comparisons

            const comparisons = [];
            for (let i = 0; i < numEmployees; i++) {
                for (let j = i + 1; j < numEmployees; j++) {
                    comparisons.push([i, j]);
                }
            }

            if (numEmployees <= 1) { // If only 0 or 1 employee, skip comparison for this criterion
                // Set default priority vector (1 for single employee, or empty)
                employeePriorityVectors[currentCriteria] = numEmployees === 1 ? [1.0] : [];
                employeeCRs[currentCriteria] = { cr: 0.0, message: "Konsisten" };
                currentCriteriaIdx++;
                compareEmployees(); // Move to the next criterion or results
                return;
            }

            comparisons.forEach((pair, index) => {
                const [idx1, idx2] = pair;
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200'; /* Changed background for comparison items */
                div.innerHTML = `
                    <label for="employee_comp_${index}" class="block text-slate-800 text-md font-semibold mb-3">
                        Seberapa baik <span class="font-bold text-blue-700">${employeeNames[idx1]}</span> dibandingkan <span class="font-bold text-blue-700">${employeeNames[idx2]}</span> dalam kriteria <span class="font-bold text-blue-700">${currentCriteria}</span>?
                    </label>
                    <input type="range" id="employee_comp_${index}" name="employee_comp_${index}" min="1" max="9" step="1" value="1"
                            oninput="this.nextElementSibling.value = this.value">
                    <output class="block text-center text-blue-600 font-bold mt-2">1</output>
                `;
                employeeComparisonsDiv.appendChild(div);
            });
            showSection('compare-employees-section', 4);
        }

        function prevCriteria() {
            currentCriteriaIdx--;
            if (currentCriteriaIdx < 0) {
                // This case should be handled by updating the back button's behavior in compareEmployees
                // For safety, we can just go back to define employees if somehow this is called inappropriately
                showSection('define-employees-section', 3);
                return;
            }
            compareEmployees();
        }

        function calculateEmployeePriorities() {
            const errorDisplay = document.getElementById('compare-employees-error');
            const currentCriteria = criteriaNames[currentCriteriaIdx];

            if (numEmployees <= 1) { // Already handled in compareEmployees, just ensure state is correct
                 currentCriteriaIdx++;
                 compareEmployees();
                 return;
            }

            const employeeMatrix = createMatrix(numEmployees, numEmployees);
            for (let i = 0; i < numEmployees; i++) {
                employeeMatrix[i][i] = 1; // Diagonal elements are 1
            }

            const comparisons = [];
            for (let i = 0; i < numEmployees; i++) {
                for (let j = i + 1; j < numEmployees; j++) {
                    comparisons.push([i, j]);
                }
            }

            comparisons.forEach((pair, index) => {
                const [idx1, idx2] = pair;
                const value = parseFloat(document.getElementById(`employee_comp_${index}`).value);
                employeeMatrix[idx1][idx2] = value;
                employeeMatrix[idx2][idx1] = 1 / value;
            });

            const priorityVector = calculatePriorityVector(employeeMatrix);
            const { cr, message } = calculateConsistencyRatio(employeeMatrix, priorityVector);

            employeeMatrices[currentCriteria] = employeeMatrix;
            employeePriorityVectors[currentCriteria] = priorityVector;
            employeeCRs[currentCriteria] = { cr: cr, message: message };

            if (cr > 0.10) {
                errorDisplay.textContent = `Perbandingan karyawan untuk kriteria '${currentCriteria}' tidak konsisten (CR = ${cr.toFixed(4)}). Mohon periksa kembali input Anda.`;
                errorDisplay.classList.remove('hidden');
                return;
            }
            errorDisplay.classList.add('hidden');
            currentCriteriaIdx++;
            compareEmployees(); // Move to the next criterion or results
        }

        function showResults() {
            const finalScores = Array(numEmployees).fill(0);

            if (numEmployees === 0) {
                // No employees to rank, display empty results gracefully
                document.getElementById('criteria-weights-table').querySelector('tbody').innerHTML = '<tr><td colspan="2" class="text-center text-slate-500">Tidak ada kriteria yang ditentukan.</td></tr>';
                document.getElementById('criteria-cr-value').textContent = 'N/A';
                document.getElementById('criteria-consistency-message').textContent = 'Tidak berlaku';
                document.getElementById('criteria-cr-warning').classList.add('hidden');

                document.getElementById('ranked-employees-table').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="text-center text-slate-500">Tidak ada karyawan yang dinilai.</td></tr>';
                document.getElementById('employee-crs-table').querySelector('tbody').innerHTML = '<tr><td colspan="3" class="text-center text-slate-500">Tidak ada perbandingan karyawan.</td></tr>';

                showSection('results-section', 5);
                return;
            }

            criteriaNames.forEach((criteriaName, i) => {
                if (employeePriorityVectors[criteriaName]) {
                    const criteriaWeight = criteriaPriorityVector[i] || 0; // Handle case where criteriaWeight might be undefined
                    employeePriorityVectors[criteriaName].forEach((empWeight, j) => {
                        finalScores[j] += criteriaWeight * empWeight;
                    });
                }
            });

            // Rank employees
            const rankedEmployees = employeeNames.map((name, index) => ({
                name: name,
                score: finalScores[index]
            })).sort((a, b) => b.score - a.score); // Sort descending

            // Populate Criteria Weights Table
            const criteriaWeightsTableBody = document.getElementById('criteria-weights-table').querySelector('tbody');
            criteriaWeightsTableBody.innerHTML = '';
            if (numCriteria > 0) {
                criteriaNames.forEach((name, i) => {
                    const row = criteriaWeightsTableBody.insertRow();
                    const cell1 = row.insertCell();
                    const cell2 = row.insertCell();
                    cell1.textContent = name;
                    cell2.textContent = criteriaPriorityVector[i] ? criteriaPriorityVector[i].toFixed(4) : 'N/A';
                });
            } else {
                criteriaWeightsTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-slate-500">Tidak ada kriteria yang ditentukan.</td></tr>';
            }

            document.getElementById('criteria-cr-value').textContent = criteriaCR.toFixed(4);
            document.getElementById('criteria-consistency-message').textContent = criteriaCR <= 0.10 ? "(Konsisten)" : "(Tidak Konsisten)";
            if (criteriaCR > 0.10) {
                document.getElementById('criteria-cr-warning').classList.remove('hidden');
            } else {
                document.getElementById('criteria-cr-warning').classList.add('hidden');
            }

            // Populate Ranked Employees Table
            const rankedEmployeesTableBody = document.getElementById('ranked-employees-table').querySelector('tbody');
            rankedEmployeesTableBody.innerHTML = '';
            rankedEmployees.forEach((emp, index) => {
                const row = rankedEmployeesTableBody.insertRow();
                const cell1 = row.insertCell();
                const cell2 = row.insertCell();
                const cell3 = row.insertCell();
                cell1.textContent = index + 1; // Rank
                cell2.textContent = emp.name;
                cell3.textContent = emp.score.toFixed(4);
            });

            // Populate Employee CRs Table
            const employeeCRsTableBody = document.getElementById('employee-crs-table').querySelector('tbody');
            employeeCRsTableBody.innerHTML = '';
            if (numCriteria > 0) {
                criteriaNames.forEach(criteriaName => {
                    const crData = employeeCRs[criteriaName];
                    if (crData) {
                        const row = employeeCRsTableBody.insertRow();
                        const cell1 = row.insertCell();
                        const cell2 = row.insertCell();
                        const cell3 = row.insertCell();
                        cell1.textContent = criteriaName;
                        cell2.textContent = crData.cr.toFixed(4);
                        cell3.textContent = crData.message;
                        if (crData.cr > 0.10) {
                            cell3.innerHTML += `<span class="text-red-600 font-bold"> - Perlu perbaikan!</span>`;
                        }
                    }
                });
            } else {
                employeeCRsTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-slate-500">Tidak ada perbandingan karyawan.</td></tr>';
            }


            showSection('results-section', 5);
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>